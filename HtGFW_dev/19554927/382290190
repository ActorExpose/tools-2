19554927
answer
382290190
https://www.zhihu.com/question/270396590/answer/382290190
车小胖
HTTPS为什么可以穿越NAT端口映射设备？

之所以产生这个理解偏差，可能是因为不熟悉端口映射（PAT）工作原理而造成的。为了更好地理解PAT的工作原理，先问自己几个问题：Q1: 为何事先在NAT设备做端口映射？Q2: 为何不把公网IP直接配置在https服务器上，而是把公网IP配置在NAT设备上？Q3: 端口映射（PAT）工作在哪层？Q4：客户端的TCP连接终结（Termination）在哪里？以下是问题的回答A1: 只有公网IP才可以在互联网上被用户访问，而服务器的私有IP无法被互联网用户访问，假设公司的公网IP = 1.1.1.1，服务器IP = 10.0.0.1，端口映射将产生以下静态表项：NAT设备一旦接收目的IP + 端口号为1.1.1.1:443的报文，就会转换为10.0.0.1:443，并将转换好的IP报文继续转发给服务器。A2：如果把公网IP直接配置在https服务器上，那么公网IP就被https服务器独占了，工作在别的端口号的服务器，如21、80、445端口就无法被互联网用户访问。而在NAT设备上做21、80、443、445端口映射，可以将这些端口分别映射到特定的服务器上。A3：端口映射工作在三四层，三层为IP，四层为TCP/UDP。A4: 如下图所示，客户端的TCP连接被https服务器终结，而不是NAT设备，NAT设备只是做三四层地址+端口号的转换，仅此而已。如上图，在NAT设备眼里，TLS及应用层的http仅仅是货物，NAT设备对这些货物并不关心是什么，更不会尝试去理解或修改。同理，客户端的TLS安全会话也是终结在https服务器上，所以和安全有关的话题，如安全加密组件协商、数字证书认证、服务器的私钥签名、RSA交换密钥算法、DH交换密钥算法等等，都是在客户端与服务器之间进行的，无需NAT设备的参与，所以NAT设备无需任何TLS安全有关的配置，仅仅做好自己本职工作即可。更多详细内容，请关注微信公众号：车小胖谈网络http://weixin.qq.com/r/gURrc3zEfCEDrTgQ9xGT (二维码自动识别)