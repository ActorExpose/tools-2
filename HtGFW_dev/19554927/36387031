19554927
article
36387031
https://zhuanlan.zhihu.com/p/36387031
W-Pwn
极简科普：虚拟机与病毒的攻防

虚拟机（Virtual Machine）指通过软件模拟的具有完整硬件系统功能的、运行在一个完全隔离环境中的完整计算机系统，已经成为许多评测人员和计算机病毒分析人员必需工作条件。由于大部分的病毒及木马都会加密加壳，所以在未激活的状态下杀毒软件是无法进行扫描的。而 “虚拟机杀毒技术”即是在电脑中创造一个虚拟CPU环境，将病毒在虚拟环境中激活，根据其行为特征，从而判断是否是病毒，同时观察病毒的执行过程，通过特征码查毒法对其进行查杀。因此，也有不少“狡猾”的病毒发展出了辨别虚拟机的技术。例如近期研究人员发现的恶意软件GravityRAT（RAT，remote access tool：远程访问工具），使用了七种不同的技术来嗅探研究人员的虚拟机（virtual machines）和沙箱环境（sandbox environments）。根据思科Talos威胁研究部门的分析，名为GravityRAT的恶意软件在两年前出现，允许攻击者在受影响的机器上执行侦察、扫描文件并执行任意代码。GravityRAT通过一个包含嵌入式恶意宏的Microsoft Office文档感染计算机，它诱使受害者启用的同时禁用保护模式。该宏包含三个功能：一个将活动文档复制到临时目录中，并将其重命名为ZIP存档；一个解压缩.zip文件并提取其中的恶意可执行文件；一个创建每天执行此文件的计划任务。“通过这种方法，攻击者确保没有直接执行，不必下载额外的载荷。”但是，GravityRat的真正独特之处在于它避开了通常为恶意软件研究和分析而创建的虚拟环境。该恶意软件通过七种方式尝试识别受感染系统是否为虚拟机，其中最不寻常的是使用WMI（Windows Management Instrumentation）请求来检查当前CPU温度。这种策略非常有效，因为Hyper-V、VMWare Fusion、VirtualBox、KVM和XEN等虚拟机管理程序不支持温度检查功能。因此，来自WMI请求的响应立刻会给该恶意软件发出一个红色标记。“这是第一个使用WMI请求来获取当前温度以检测虚拟环境的方法，相当聪明，既高效又可靠。”这个GravityRAT恶意软件一定程度上将反“虚拟机”检测技术做到了极致，其他六种辨别技术还有：1.查看安装在系统上的管理程序使用的其他工具（通过检查注册表项）。Looking at any additional tools used by the hypervisor that are installed on the system (by checking a registry key).2.使用WMI请求BIOS版本（Win32_BIOS条目）。如果响应包含：'VMware'，' Virtual '，'XEN'，'Xen'或'AMI'，则系统被视为虚拟机。此外，恶意软件会检查SerialNumber和BIOS的版本。Using a WMI request to the BIOS version (Win32_BIOS entry). If the response contains: 'VMware,' 'Virtual,' 'XEN,' 'Xen' or 'A M I' the system is considered as a virtual machine. Additionally, the malware checks the SerialNumber and the version of the BIOS.3.使用WMI中的Win32_Computer条目，检查制造商是否包含’VIRTUAL’，’VMWARE’或’VirtualBox’。[Using] the Win32_Computer entry in WMI. It checks if the manufacturer contains 'VIRTUAL,' 'VMWARE' or 'VirtualBox'.4.检查系统的处理器ID。Checking the system's Processor ID.5.计算受感染系统中的CPU核数量。Counting the number of cores in the infected system.6.检查机器的MAC地址以确定它是否以十六进制数字开始。如果是这样，则系统被识别为虚拟机。Checking the machine's MAC Address to determine if it starts by a well-known hexadecimal number. If so, the system is identified as a virtual machine.自2016年12月，研究人员发现第一个基于.Net的G1恶意软件，现在已经出现了四种不同的GravityRAT变体。第一个版本的目标是执行命令并窃取数据，如MAC地址、计算机名称、用户名、IP地址、日期以及映射到系统上的各种文件和卷。G2版本于2017年7月首次出现，其中包含一个诱饵图片文档，可以通过WMI请求，收集Win32_Processor条目中的CPU信息来辨别虚拟机环境。G3在2017年8月出现，它引入了对其他语言的支持，并且具有不同的C＆C服务器后端以及更改后的URI。就在几周前，Talos发现了最新的GX，最先进的GravityRAT版本，其中包括所有七种反虚拟机技术。GravityRAT主要针对印度的服务器基础设施。目前发现的所有与威胁相关的恶意Office文档以及恶意可执行文件都是从巴基斯坦提交的。它的开发者名为The Invincible和The Martian，是在程序中泄露的，不知是心不在焉还是故意作为诱饵了。WTT资讯-最新科技资讯，实时网安信息​www.wttech.org欢迎关注我们：@W-Pwn