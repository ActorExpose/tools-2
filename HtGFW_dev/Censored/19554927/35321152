19554927
article
35321152
https://zhuanlan.zhihu.com/p/35321152
拼客学院陈鑫杰
[漏洞复现] CVE-2017-7494 隐藏7年之久的Linux版"永恒之蓝"出现了...

1、漏洞概述哪一年才算是真正的“网络安全元年”？相信很多人会不约而同得出这个结果：2017年。在这一年头里，先是“WannaCry永恒之蓝”横空出世席卷全球，紧接着是NSA/CIA等核武器级网络军火库持续“失火”引起恐慌。 从操作系统到应用软件，从Web容器到服务插件，各种0day漏洞应接不暇；之后又是数字货币热潮带来的挖矿程序蠕虫爆发……总之，2017年的互联网安全，用“多灾多难”来形容，最为不过。当然，事物总有双面性，有坏的一面，也有好的一面。在历史性经历过这些安全大事件之后，上到国家，下至民众，开始对这个行业投入更多关注。例如：2017年6月，我国的《网络安全法》终于颁发；到了9月，由中央网信办和教育部牵头颁发了《关于加快网络安全学科建设和人才培养的意见》，并公布了首批7个一流网络安全学院建设示范项目，到现在我们就开始看到各大高等院校陆续开设了“信息安全专业”……写上面这段背景内容，无非想告诉大家：2017年有重大意义，并且这一年出来的漏洞，能折腾的太多了！这不，今天要讲的这枚漏洞，跟WannaCry永恒之蓝类似，同样在17年5月爆发，同样攻击威力巨大并持续升级发酵，但在当时，确实被远远低估了。2017年5月24号，Samba官方发布4.6.4版本，声明修复了一个严重漏洞（CVE-2017-7494），可以造成远程代码执行，运行Samba服务的Linux/Unix设备，可能会被直接getshell。 由于攻击的对象主要是运行Linux/Unix系统的设备，当时无论是媒体还是普通小白，大部分注意力其实还是放在“WannaCry永恒之蓝”上面。而实际上，无论是黑帽还是白帽，大家都敏锐的嗅到：这枚漏洞的价值和攻击威力，可能要比WannaCry高！这里简单做个普及：我们日常办公的电脑，主流是Windows操作系统；而平常上网访问的“网站”，或者玩游戏时登录的“服务器”，几乎都是Linux操作系统。随着“云”的发展，大家已经习惯了将数据“云端化”，例如，将个人资料存入网盘。这意味着：我们的隐私数据，例如个人照片、办公文档、网银支付、游戏存档等，大部分存储在这些Linux服务器上面。所以说，这枚漏洞后面被称为“SambaCry”或者"Linux版WannaCry"毫不夸张。WannaCry能够攻击我们的Windows电脑，“SambaCry”则能够攻击存储数据的Linux服务器。简单来说，一个是从前门进来的强盗，一个是从后院进来的小偷……到了2017年中下旬直至现在，“比特币”、“区块链”、“糖果”等概念已经火的一塌涂地。虽然国家不断介入监管，但是票圈天天被刷屏带节奏，连小区楼下大妈讨论的话题都逐渐从炒黄金变成了炒币，很多人正式加入挖矿和炒币大军。按照“钱在哪黑客就在哪”法则，很多黑客开始利用技术手段进行挖矿牟利。众所周知，挖矿最最最重要的一点，就是要有足够强劲的计算能力。因此，很多黑客开始把攻击目标集中到服务器，无论是游戏、直播、媒体、电商、金融、政府等各行各业的服务器，性能相比Windows桌面电脑，是其几倍甚至数十倍以上。而SambaCry这样的0 day漏洞在这个时间节点上出现，简直不能更及时。例如，基于SambaCry进行二次研发的挖矿病毒例如“EternalMiner”陆续出现，当一台Linux服务器被这样的病毒入侵并控制之后，这类病毒会上传挖矿程序，“吃光”服务器的计算资源，执行“挖币”。截止目前，互联网上仍然有海量的没有修复Samba漏洞的Linux设备正在持续运行着，成为名副其实的“挖矿肉鸡”。在传统的黑产链条里，黑客入侵目标服务器之后，需要获取敏感数据，然后进行数据清洗，再拿去倒卖，整个变现链条非常长，并且匿名不够好。而现在，“0 day漏洞 -> 拿下服务器 -> 挖币”，整个黑产变现链条被大大缩减，而且保证了匿名性。漏洞原理： Samba是在Linux或Unix系统上用来实现文件共享和打印服务的通信协议，也是很多家用的智能硬件设备例如NAS设备内置的协议，采用服务端口445。由于Samba内置函数is_known_pipename里面出现字符过滤问题，导致攻击者可以向共享目录传递恶意文件，导致被远程代码执行。参考链接：https://cvedetails.com/cve/CVE-2017-7494/https://www.samba.org/samba/security/CVE-2017-7494.html影响版本： Samba 3.5.0 之后到4.6.4/4.5.10/4.4.14中间的所有版本。渗透代码： 关于此Samba漏洞的渗透利用代码，最早发布的，便是鼎鼎大名的Metasploit创始人HD Moore。HD Moore出名，不仅仅在黑客和安全圈，在目前的币圈也是一位传奇，毕竟手握约40万个比特币，是世界上除了比特币创始人中本聪之外，持币量最多的人。就是这位“比你有钱又比你有才”的传奇人物，他在Samba漏洞公告的第二天，也就是2017年5月25号，就在github上公布了针对此漏洞的exp代码。当然，目前Metasploit框架也已经集成了这个exp代码。 2、漏洞复现环境Kali Linux 2018 <-> Kali Linux 2017 渗透机：Kali Linux 2018（ip：172.16.70.132） 靶机：Kali Linux 2017（ip：172.16.70.216）注：你没看错，之前5个实验里面一直作为渗透机的Kali 2017，在今天这里，却要沦为“肉鸡”。因为Kali 2017版本，内置的Samba版本刚好是没有修复的，这刚好验证了“没有永恒的安全“，即便是黑客自己的电脑，也有被攻击的一天。所以，这次漏洞复现实验，我们拿最新的Kali 2018作为渗透机，来“降维”攻击Kali 2017……老规矩，为了节省大家实验时间，我将此实验涉及到的工具全部上传到网盘，若之前下载过，则无需重复下载=> 链接: https://pan.baidu.com/s/177h1_sAQTn2XaIJBubeMQQ 密码:ykzi3、实验流程①进入Kali Linux 2017，查看Samba版本root@kali:~# samba --version Version 4.5.8-Debian 